<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password | GPS Pethgam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">

    <div class="max-w-md w-full bg-white p-8 rounded-3xl shadow-xl border border-slate-200">
        <div class="text-center mb-8">
            <div class="bg-orange-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-key text-orange-600 text-2xl"></i>
            </div>
            <h2 class="text-2xl font-black text-slate-800 uppercase tracking-tighter">Reset Password</h2>
            <p class="text-xs text-slate-500 font-bold mt-1">Verify your identity to change your ERP password</p>
        </div>

        <div id="stepVerify" class="space-y-4">
            <div>
                <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">Registered Email</label>
                <input type="email" id="verifyEmail" placeholder="teacher@gpspethgam.com" class="w-full p-4 rounded-2xl border bg-slate-50 font-bold text-sm outline-none focus:ring-2 focus:ring-orange-500">
            </div>
            <div>
                <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">Contact Number</label>
                <input type="tel" id="verifyPhone" placeholder="10-digit mobile number" class="w-full p-4 rounded-2xl border bg-slate-50 font-bold text-sm outline-none focus:ring-2 focus:ring-orange-500">
            </div>
            <button onclick="verifyTeacher()" id="verifyBtn" class="w-full bg-slate-900 text-white font-black py-4 rounded-2xl hover:bg-black transition shadow-lg">
                VERIFY ACCOUNT
            </button>
        </div>

        <div id="stepReset" class="hidden space-y-4">
            <div class="bg-emerald-50 p-3 rounded-xl border border-emerald-100 mb-4">
                <p class="text-[10px] text-emerald-700 font-bold"><i class="fas fa-check-circle"></i> Identity Verified! Enter new password below.</p>
            </div>
            <div>
                <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">New Password</label>
                <input type="password" id="newPass" placeholder="Enter new password" class="w-full p-4 rounded-2xl border bg-slate-50 font-bold text-sm outline-none focus:ring-2 focus:ring-emerald-500">
            </div>
            <button onclick="updatePassword()" id="resetBtn" class="w-full bg-emerald-600 text-white font-black py-4 rounded-2xl hover:bg-emerald-700 transition shadow-lg">
                UPDATE PASSWORD
            </button>
        </div>

        <div class="mt-6 text-center">
            <a href="login.html" class="text-[10px] font-black text-slate-400 uppercase hover:text-orange-600 transition">Back to Login</a>
        </div>
    </div>

    <script type="module">
        import { db } from './init-firebase.js';
        import { collection, query, where, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let targetTeacherDocId = "";

        window.verifyTeacher = async () => {
            const email = document.getElementById('verifyEmail').value.trim();
            const phone = document.getElementById('verifyPhone').value.trim();
            const btn = document.getElementById('verifyBtn');

            if(!email || !phone) return alert("Please fill both fields");

            btn.disabled = true;
            btn.innerText = "VERIFYING...";

            try {
                // Search for staff with matching email AND contact
                const q = query(collection(db, "staffRecords"), 
                    where("email", "==", email), 
                    where("contact", "==", phone)
                );
                
                const snap = await getDocs(q);

                if (snap.empty) {
                    alert("No matching record found. Please contact the Headmaster.");
                    btn.disabled = false;
                    btn.innerText = "VERIFY ACCOUNT";
                } else {
                    targetTeacherDocId = snap.docs[0].id; // Store ID for update
                    document.getElementById('stepVerify').classList.add('hidden');
                    document.getElementById('stepReset').classList.remove('hidden');
                }
            } catch (e) {
                console.error(e);
                alert("Verification failed.");
                btn.disabled = false;
            }
        };

        window.updatePassword = async () => {
            const newPass = document.getElementById('newPass').value;
            const btn = document.getElementById('resetBtn');

            if(newPass.length < 4) return alert("Password too short!");

            btn.disabled = true;
            btn.innerText = "UPDATING...";

            try {
                const staffRef = doc(db, "staffRecords", targetTeacherDocId);
                await updateDoc(staffRef, {
                    password: newPass
                });
                alert("Password Updated Successfully! Please login.");
                window.location.href = "login.html";
            } catch (e) {
                alert("Error updating password.");
                btn.disabled = false;
            }
        };
    </script>
</body>
</html>

