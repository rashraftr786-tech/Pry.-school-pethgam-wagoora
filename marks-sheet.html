<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Report Card | GPS Pethgam Wagoora</title>
  <style>
    @page { size: A4; margin: 10mm; }
    body { font-family: sans-serif; margin: 0; font-size: 11px; }
    .card { width: 190mm; border: 2px solid #5a3d8c; margin: auto; }
    
    .top-header { background: #5a3d8c; color: white; display: flex; align-items: center; padding: 10px; }
    .logo { width: 60px; height: 60px; margin-right: 15px; background: white; border-radius: 50%; }
    .title-text { text-align: center; flex-grow: 1; }
    
    .info-grid { display: grid; grid-template-columns: 1.5fr 1fr 1fr; border-bottom: 1px solid #000; }
    .info-item { border: 0.5px solid #ccc; padding: 4px; display: flex; }
    .info-item b { width: 90px; color: #5a3d8c; }

    table.main-table { width: 100%; border-collapse: collapse; text-align: center; }
    table.main-table th, table.main-table td { border: 1px solid #000; padding: 3px; }
    .bg-purple { background: #dcd0ff; font-weight: bold; }
    .bg-green { background: #e8f5e9; }
    
    .bottom-section { display: grid; grid-template-columns: 1fr 1fr 1fr; height: 180px; }
    .box { border: 1px solid #000; padding: 5px; }
    
    .footer-sigs { display: grid; grid-template-columns: repeat(4, 1fr); margin-top: 40px; text-align: center; border-top: 1px solid #000; padding-top: 5px; font-weight: bold; }
  </style>
</head>
<body>

<div class="card">
  <div class="top-header">
    <img src="logo.png" class="logo">
    <div class="title-text">
      <h2 style="margin:0">GOVERNMENT PRIMARY SCHOOL</h2>
      <h3 style="margin:0">PETHGAM WAGOORA 193109</h3>
    </div>
  </div>

  <div id="studentInfo" class="info-grid"></div>

  <table class="main-table">
    <tr class="bg-purple">
      <th>Subject</th>
      <th>FA1-FA6 (30)</th>
      <th>CCA (20)</th>
      <th>SA (50)</th>
      <th>Total (100)</th>
      <th>Grade</th>
      <th>Proficiency</th>
    </tr>
    <tbody id="marksBody"></tbody>
    <tr class="bg-purple">
      <td>Grand Total</td><td id="gtFa"></td><td id="gtCca"></td><td id="gtSa"></td><td id="gtTotal"></td><td id="gtGrade"></td><td></td>
    </tr>
  </table>

  <div class="bottom-section">
    <div class="box">
      <b style="color: blue;">Final Results</b><br><br>
      Total Obtained: <span id="resTotal"></span><br>
      Max Marks: 500<br>
      Percentage: <span id="resPerc"></span><br>
      Grade: <span id="resGrade"></span><br>
      Result: <b id="resFinal"></b>
    </div>
    <div class="box">
      <b>General Remarks</b><br>
      <p id="resRemarks" style="font-size: 10px;"></p>
    </div>
    <div class="box">
      <b>Attendance %:</b> <span id="resAtt"></span><br><br>
      <span>School Rank: <b id="rankS"></b></span><br>
      <span>Class Rank: <b id="rankC"></b></span>
    </div>
  </div>

  <div class="footer-sigs">
    <div>Sign. Form Teacher</div>
    <div>Sign. Exam I/C</div>
    <div>Parents Signature</div>
    <div>Seal & Sign. Headmaster</div>
  </div>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const admNo = params.get("admNo");

const admissions = JSON.parse(localStorage.getItem("admissions")) || [];
const results = JSON.parse(localStorage.getItem("results")) || [];
const sInfo = admissions.find(x => x.admNo === admNo);
const sMarks = results.find(x => x.admNo === admNo);

if(sInfo && sMarks) {
    document.getElementById('studentInfo').innerHTML = `
        <div class="info-item"><b>Student Name:</b> ${sInfo.studentName}</div>
        <div class="info-item"><b>Adm No:</b> ${admNo}</div>
        <div class="info-item"><b>Roll No:</b> ${sMarks.rollNo}</div>
        <div class="info-item"><b>Father:</b> ${sInfo.fatherName}</div>
        <div class="info-item"><b>Class:</b> ${sInfo.studentClass}</div>
        <div class="info-item"><b>D.O.B:</b> ${sInfo.dob}</div>
    `;

    let gtFa = 0, gtCca = 0, gtSa = 0, gtTotal = 0;
    
    Object.keys(sMarks.marks).forEach(sub => {
        const m = sMarks.marks[sub];
        const faSum = m.fa.reduce((a, b) => a + b, 0);
        const total = faSum + m.cca + m.sa;
        
        gtFa += faSum; gtCca += m.cca; gtSa += m.sa; gtTotal += total;

        const grade = total > 85 ? 'A+' : total > 70 ? 'A' : total > 55 ? 'B' : total > 33 ? 'C' : 'E';
        const prof = total > 70 ? 'Sky' : total > 45 ? 'Mountain' : 'Stream';

        document.getElementById('marksBody').innerHTML += `
            <tr>
                <td>${sub}</td><td>${faSum}</td><td>${m.cca}</td><td>${m.sa}</td><td>${total}</td><td>${grade}</td><td>${prof}</td>
            </tr>`;
    });

    document.getElementById('gtFa').innerText = gtFa;
    document.getElementById('gtCca').innerText = gtCca;
    document.getElementById('gtSa').innerText = gtSa;
    document.getElementById('gtTotal').innerText = gtTotal;
    
    const finalPerc = Math.round(gtTotal / 5);
    document.getElementById('resTotal').innerText = gtTotal;
    document.getElementById('resPerc').innerText = finalPerc + "%";
    document.getElementById('resAtt').innerText = sMarks.attendance || '0';
    document.getElementById('resRemarks').innerText = sMarks.remarks;
}
</script>
</body>
</html>
  </table>

  <table class="marks-table" style="width: 60%; margin: 0 auto;">
    <tr>
      <th class="section-title">Percentage</th><td id="percent"></td>
      <th class="section-title">Grade</th><td id="grade"></td>
    </tr>
    <tr>
      <th class="section-title">Result</th><td colspan="3" id="result" style="font-weight: bold;"></td>
    </tr>
  </table>

  <div class="grading-scale">
    <b>Grading Scale:</b> A+: 85-100% | A: 70-84% | B: 55-69% | C: 40-54% | D: 33-39% | E: Below 33% (Needs Improvement)
  </div>

  <div class="footer">
    <div class="sig">Class Teacher</div>
    <div class="sig">Exam Incharge</div>
    <div class="sig">Parent's Signature</div>
    <div class="sig">Headmaster Stamp</div>
  </div>
</div>

<button class="print-btn" onclick="window.print()">Download Marksheet (PDF)</button>

<script>
const params = new URLSearchParams(window.location.search);
const studentId = params.get("admNo");

// 1. Get Student Personal Info from Admission Register
const admissionRecords = JSON.parse(localStorage.getItem("admissions")) || [];
const studentInfo = admissionRecords.find(x => x.admNo === studentId);

// 2. Get Academic Marks from Results storage
const resultRecords = JSON.parse(localStorage.getItem("results")) || [];
const marksInfo = resultRecords.find(x => x.admNo === studentId);

if(!studentInfo || !marksInfo){
  alert("Student Data or Result not found in system.");
} else {
  // Fill Personal Data
  document.getElementById("sname").innerText = studentInfo.studentName;
  document.getElementById("admNo").innerText = studentInfo.admNo;
  document.getElementById("class").innerText = studentInfo.studentClass;
  document.getElementById("parentage").innerText = "Mr. " + studentInfo.fatherName;
  document.getElementById("dob").innerText = studentInfo.dob;
  document.getElementById("rollNo").innerText = marksInfo.rollNo || "N/A";
  document.getElementById("studentPhoto").src = studentInfo.studentPhoto || "logo.png";

  // Fill Marks Data
  let total = 0;
  const subs = ['english', 'math', 'evs', 'urdu', 'kashmiri'];
  subs.forEach(sub => {
    let score = marksInfo.subjects[sub] || 0;
    document.getElementById(sub).innerText = score;
    total += parseInt(score);
  });

  document.getElementById("total").innerText = total;
  let percent = Math.round((total / 500) * 100);
  document.getElementById("percent").innerText = percent + "%";

  let grade = percent >= 85 ? "A+" : percent >= 70 ? "A" : percent >= 55 ? "B" : percent >= 40 ? "C" : percent >= 33 ? "D" : "E";
  document.getElementById("grade").innerText = grade;
  document.getElementById("result").innerText = percent >= 33 ? "PASSED" : "PROMOTED WITH REMARKS";
}
</script>
</body>
</html>
