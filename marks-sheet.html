<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Official Report Card - GPS Pethgam Wagoora</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 1. Page Configuration */
        @page { 
            size: A4 landscape; 
            margin: 0; 
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; 
            padding: 0; 
            background: #f0f0f0;
            -webkit-print-color-adjust: exact !important; 
            print-color-adjust: exact !important; 
        }

        .printable-area {
            width: 297mm; 
            height: 210mm; 
            background: white;
            margin: 0 auto;
            padding: 10mm; 
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            border: 4px solid #5a3d8c;
            overflow: hidden;
        }

        /* 2. Header */
        .school-header { 
            background: #5a3d8c !important; 
            color: white !important; 
            display: flex; 
            align-items: center; 
            padding: 10px; 
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        .school-logo { width: 70px; height: 70px; background: white; border-radius: 50%; padding: 5px; margin-right: 15px; }
        .header-text { flex-grow: 1; text-align: center; }
        .header-text h1 { margin: 0; font-size: 22px; letter-spacing: 1px; }
        .header-text h2 { margin: 2px 0; font-size: 14px; font-weight: normal; }
        .header-contacts { font-size: 10px; margin-top: 5px; display: flex; justify-content: center; gap: 20px; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 4px; }

        /* 3. Updated Student Profile Area */
        .top-info-container { 
            display: flex; 
            gap: 10px; 
            margin-top: 10px; 
            align-items: stretch;
            width: 100%;
        }
        .details-table { flex: 1; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th, td { border: 1px solid #444; padding: 5px; text-align: center; }
        .label-cell { 
            background: #e1f5fe !important; 
            text-align: left; 
            font-weight: bold; 
            width: 110px; 
        }
        .data-cell { text-align: left; padding-left: 8px; }

        .class-box-container { 
            width: 100px; 
            border: 1px solid #444; 
            display: flex; 
            flex-direction: column; 
            text-align: center;
        }
        .class-label { background: #5a3d8c; color: white; font-weight: bold; padding: 4px; font-size: 11px; }
        .class-value { flex-grow: 1; display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: bold; color: #5a3d8c; }

        .photo-box {
            width: 110px;
            border: 2px solid #5a3d8c;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fafafa;
        }
        .photo-box img { width: 100%; height: 100%; object-fit: cover; }

        /* 4. Subject Table */
        .subject-table { margin-top: 10px; width: 100%; }
        .subject-table th { background: #dcd0ff !important; font-size: 10px; }
        .subject-name { text-align: left; font-weight: bold; color: #b71c1c; padding-left: 10px; }

        /* 5. Bottom Layout - Remarks Expansion */
        .bottom-grid { 
            display: grid; 
            grid-template-columns: 28% 44% 28%; 
            gap: 10px; 
            margin-top: 10px; 
            flex-grow: 1; 
            align-items: stretch; /* Ensures all columns are same height */
        }
        .section-box { border: 1px solid #444; display: flex; flex-direction: column; height: 100%; }
        .section-header { background: #5a3d8c !important; color: white !important; font-weight: bold; padding: 4px; text-align: center; font-size: 12px; }
        
        .remarks-content { 
            padding: 8px; 
            font-size: 11px; 
            font-style: italic; 
            flex-grow: 1; /* This pushes the box to fill available vertical space */
            display: flex;
            align-items: flex-start;
        }
        
        .chart-wrap { flex-grow: 1; padding: 5px; min-height: 150px; display: flex; align-items: center; justify-content: center; }
        .prof-row { display: flex; justify-content: space-between; padding: 5px 10px; border-bottom: 1px solid #eee; font-size: 11px; }

        /* 6. Footer Signatures */
        .footer-sigs { 
            display: flex; 
            justify-content: space-between; 
            margin-top: 15px; 
            padding-top: 10px;
            width: 100%;
        }
        .sig-block { width: 22%; text-align: center; }
        .sig-space { height: 35px; }
        .sig-label { border-top: 1px solid #000; padding-top: 4px; font-size: 11px; font-weight: bold; }

        /* 7. Print Settings */
        .btn-download { position: fixed; bottom: 20px; right: 20px; padding: 12px 25px; background: #2e7d32; color: white; border: none; cursor: pointer; border-radius: 30px; font-weight: bold; z-index: 100; }
        @media print {
            .btn-download { display: none; }
            body { background: white; }
            .printable-area { margin: 0; border: 4px solid #5a3d8c; }
        }
    </style>
</head>
<body>

<div class="printable-area">
    <div class="school-header">
        <img src="logo.png" class="school-logo" alt="Logo">
        <div class="header-text">
            <h1>GOVERNMENT PRIMARY SCHOOL</h1>
            <h2>PETHGAM WAGOORA – PIN: 193109</h2>
            <div class="header-contacts">
                <span>UDISE: 01022202207</span>
                <span>Email: pspathgam@gmail.com</span>
                <span>Contact: +91 7006261694</span>
            </div>
        </div>
    </div>

    <div class="top-info-container">
        <div class="details-table">
            <table>
                <tr>
                    <td class="label-cell">Student Name:</td><td class="data-cell" id="sname" colspan="3" style="font-weight:bold; font-size:13px;"></td>
                </tr>
                <tr>
                    <td class="label-cell">Adm. No:</td><td class="data-cell" id="admNo"></td>
                    <td class="label-cell">Roll No:</td><td class="data-cell" id="rollNo"></td>
                </tr>
                <tr>
                    <td class="label-cell">Father's Name:</td><td class="data-cell" id="fname"></td>
                    <td class="label-cell">Mother's Name:</td><td class="data-cell" id="mname"></td>
                </tr>
                <tr>
                    <td class="label-cell">Date of Birth:</td><td class="data-cell" id="dob"></td>
                    <td class="label-cell">Session:</td><td class="data-cell" id="session"></td>
                </tr>
                <tr>
                    <td class="label-cell">Apaar ID:</td><td class="data-cell" id="apaar"></td>
                    <td class="label-cell">PEN No:</td><td class="data-cell" id="pen"></td>
                </tr>
            </table>
        </div>
        
        <div class="class-box-container">
            <div class="class-label">CLASS</div>
            <div class="class-value" id="classVal">--</div>
        </div>

        <div class="photo-box" id="photoBox">
            <span style="font-size: 10px; color: #999; text-align: center;">Affix Student<br>Photo Here</span>
        </div>
    </div>

    <table class="subject-table">
        <thead>
            <tr>
                <th width="140">Subject</th>
                <th>FA1</th><th>FA2</th><th>FA3</th><th>FA4</th><th>FA5</th><th>FA6</th>
                <th>Total(30)</th><th>CCA(20)</th><th>SA(50)</th>
                <th>Total(100)</th><th>Grade</th><th>Proficiency</th>
            </tr>
        </thead>
        <tbody id="marksBody"></tbody>
        <tr style="background:#f1f8e9; font-weight:bold;">
            <td colspan="7" style="text-align:right; padding-right:10px;">Grand Total:</td>
            <td id="gt30"></td><td id="gt20"></td><td id="gt50"></td><td id="gt100"></td>
            <td id="finalGrade"></td><td id="finalProf"></td>
        </tr>
    </table>

    <div class="bottom-grid">
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <div class="section-box">
                <div class="section-header" style="background:#b71c1c !important;">Co-Scholastic Record</div>
                <table>
                    <tr><td style="text-align:left;">Attendance %</td><td id="att" width="60"></td></tr>
                    <tr><td style="text-align:left;">Discipline</td><td>A</td></tr>
                    <tr><td style="text-align:left;">Sports / Health</td><td>B</td></tr>
                    <tr><td style="text-align:left;">Art & Craft</td><td>A</td></tr>
                </table>
            </div>
            <div class="section-box" style="flex-grow: 1;">
                <div class="section-header">General Remarks</div>
                <div class="remarks-content" id="remarksText"></div>
            </div>
        </div>

        <div class="section-box">
            <div class="section-header" style="background:#ff9800 !important;">Subject-wise Performance Chart</div>
            <div class="chart-wrap">
                <canvas id="marksChart"></canvas>
            </div>
        </div>

        <div style="display: flex; flex-direction: column; gap: 10px;">
            <div class="section-box">
                <div class="section-header">Final Result Summary</div>
                <table style="margin:0;">
                    <tr><td class="label-cell">Total Marks:</td><td id="resTotal" style="font-weight:bold;"></td></tr>
                    <tr><td class="label-cell">Percentage:</td><td id="resPerc"></td></tr>
                    <tr><td class="label-cell">Result:</td><td id="resFinal" style="color:green; font-weight:bold;">PASS</td></tr>
                </table>
            </div>
            <div class="section-box" style="flex-grow: 1;">
                <div class="section-header" style="background:#ef5350 !important;">Level of Proficiency</div>
                <div class="prof-row"><span>Sky (Excellent)</span><b id="pSky"></b></div>
                <div class="prof-row"><span>Mountain (Good)</span><b id="pMtn"></b></div>
                <div class="prof-row"><span>Stream (Average)</span><b id="pStrm"></b></div>
                <div style="background:#37474f; color:white; padding:10px; border-radius:4px; font-size:10px; text-align:center; margin: 10px 5px auto 5px;">
                    School Rank: <span id="sRank">--</span> | Class Rank: <span id="cRank">--</span>
                </div>
            </div>
        </div>
    </div>

    <div class="footer-sigs">
        <div class="sig-block"><div class="sig-space"></div><div class="sig-label">Class Teacher</div></div>
        <div class="sig-block"><div class="sig-space"></div><div class="sig-label">Exam In-Charge</div></div>
        <div class="sig-block"><div class="sig-space"></div><div class="sig-label">Parent/Guardian</div></div>
        <div class="sig-block"><div class="sig-space"></div><div class="sig-label">Headmaster Seal & Sign</div></div>
    </div>
</div>

<button class="btn-download" onclick="window.print()">Print Marksheet / Save PDF</button>

<script>
const params = new URLSearchParams(window.location.search);
const admNo = params.get("admNo");

const admissions = JSON.parse(localStorage.getItem("admissions")) || [];
const results = JSON.parse(localStorage.getItem("results")) || [];

const sortedAllResults = [...results].sort((a, b) => {
    const calcTotal = (r) => Object.values(r.marks).reduce((acc, m) => 
        acc + (m.fa.reduce((sum, f) => sum + f, 0) + m.cca + m.sa), 0);
    return calcTotal(b) - calcTotal(a);
});

const sInfo = admissions.find(x => x.admNo === admNo);
const sMarks = results.find(x => x.admNo === admNo);

if (sInfo && sMarks) {
    document.getElementById('sname').innerText = sInfo.studentName.toUpperCase();
    document.getElementById('admNo').innerText = sInfo.admNo;
    document.getElementById('fname').innerText = sInfo.fatherName;
    document.getElementById('mname').innerText = sInfo.motherName;
    document.getElementById('dob').innerText = sInfo.dob;
    document.getElementById('session').innerText = sInfo.session || "2024-25";
    document.getElementById('classVal').innerText = sInfo.studentClass;
    document.getElementById('rollNo').innerText = sMarks.rollNo;
    document.getElementById('apaar').innerText = sInfo.apaarId || "N/A";
    document.getElementById('pen').innerText = sInfo.penId || "N/A";
    document.getElementById('remarksText').innerText = sMarks.remarks || "Performance is satisfactory.";
    document.getElementById('att').innerText = sMarks.attendance || "0";
    
    const photoBox = document.getElementById('photoBox');
    if (sInfo.studentPhoto && sInfo.studentPhoto.length > 100) {
        photoBox.innerHTML = `<img src="${sInfo.studentPhoto}" alt="Student">`;
    }

    const schoolRank = sortedAllResults.findIndex(r => r.admNo === admNo) + 1;
    document.getElementById('sRank').innerText = schoolRank;

    const classResults = sortedAllResults.filter(r => {
        const student = admissions.find(a => a.admNo === r.admNo);
        return student && student.studentClass === sInfo.studentClass;
    });
    const classRank = classResults.findIndex(r => r.admNo === admNo) + 1;
    document.getElementById('cRank').innerText = classRank;

    let labels = [], data = [], gt30 = 0, gt20 = 0, gt50 = 0, gt100 = 0;
    const subjects = Object.keys(sMarks.marks);
    const marksBody = document.getElementById('marksBody');
    
    subjects.forEach(sub => {
        const m = sMarks.marks[sub];
        const faT = m.fa.reduce((a, b) => a + (Number(b) || 0), 0);
        const rowT = faT + (Number(m.cca) || 0) + (Number(m.sa) || 0);
        
        gt30 += faT; gt20 += (Number(m.cca) || 0); gt50 += (Number(m.sa) || 0); gt100 += rowT;
        labels.push(sub); 
        data.push(rowT);

        const grade = rowT > 85 ? 'A+' : rowT > 70 ? 'A' : rowT > 55 ? 'B' : rowT > 40 ? 'C' : 'D';
        const prof = rowT > 70 ? 'Sky' : rowT > 45 ? 'Mountain' : 'Stream';
        
        marksBody.innerHTML += `
            <tr>
                <td class="subject-name">${sub}</td>
                <td>${m.fa[0]}</td><td>${m.fa[1]}</td><td>${m.fa[2]}</td>
                <td>${m.fa[3]}</td><td>${m.fa[4]}</td><td>${m.fa[5]}</td>
                <td style="font-weight:bold;">${faT}</td>
                <td>${m.cca}</td>
                <td>${m.sa}</td>
                <td style="font-weight:bold;">${rowT}</td>
                <td>${grade}</td>
                <td>${prof}</td>
            </tr>`;
    });

    document.getElementById('gt30').innerText = gt30;
    document.getElementById('gt20').innerText = gt20;
    document.getElementById('gt50').innerText = gt50;
    document.getElementById('gt100').innerText = gt100;
    
    const perc = Math.round(gt100 / subjects.length);
    document.getElementById('resTotal').innerText = gt100 + " / " + (subjects.length * 100);
    document.getElementById('resPerc').innerText = perc + "%";
    
    document.getElementById('finalGrade').innerText = perc > 85 ? 'A+' : perc > 70 ? 'A' : perc > 55 ? 'B' : perc > 40 ? 'C' : 'D';
    document.getElementById('finalProf').innerText = perc > 70 ? 'Sky' : perc > 45 ? 'Mountain' : 'Stream';

    document.getElementById('pSky').innerText = perc > 70 ? "✓" : "";
    document.getElementById('pMtn').innerText = (perc > 45 && perc <= 70) ? "✓" : "";
    document.getElementById('pStrm').innerText = perc <= 45 ? "✓" : "";

    new Chart(document.getElementById('marksChart'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{ 
                label: 'Score', 
                data: data, 
                backgroundColor: '#5a3d8c', 
                borderRadius: 4
            }]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            scales: { y: { beginAtZero: true, max: 100 } },
            plugins: { legend: { display: false } }
        }
    });
} else {
    alert("Record not found!");
}
</script>

</body>
</html>
                            
