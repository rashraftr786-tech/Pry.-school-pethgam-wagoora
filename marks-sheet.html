<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Official Report Card - GPS Pethgam Wagoora</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @page { size: A4 landscape; margin: 0; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; padding: 0; background: #f0f0f0;
            -webkit-print-color-adjust: exact !important; 
            print-color-adjust: exact !important; 
        }
        .printable-area {
            width: 297mm; height: 210mm; background: white;
            margin: 0 auto; padding: 8mm 10mm; box-sizing: border-box;
            display: flex; flex-direction: column; border: 4px solid #5a3d8c;
            overflow: hidden;
        }
        .outer-boundary { width: 100%; box-sizing: border-box; }
        .school-header { 
            background: #5a3d8c !important; color: white !important; 
            display: flex; align-items: center; padding: 12px 20px; border-radius: 4px;
        }
        .school-logo { width: 80px; height: 80px; background: white; border-radius: 10%; padding: 5px; margin-right: 20px; }
        .header-text { flex-grow: 1; text-align: left; }
        .header-text h1 { margin: 0; font-size: 32px; letter-spacing: 2px; font-family: 'Arial Black', sans-serif; line-height: 1.1; }
        .header-address { font-size: 13px; margin-top: 5px; font-weight: bold; opacity: 0.9; }
        .header-right-contact { text-align: right; font-size: 11px; line-height: 1.6; border-left: 1px solid rgba(255,255,255,0.3); padding-left: 20px; }
        .top-info-container { display: flex; gap: 10px; margin-top: 10px; align-items: stretch; height: 125px; }
        .details-table { flex: 1; }
        table { width: 100%; border-collapse: collapse; font-size: 10.5px; }
        th, td { border: 1px solid #444; padding: 4px; text-align: center; }
        .label-cell { background: #e1f5fe !important; text-align: left; font-weight: bold; width: 105px; }
        .data-cell { text-align: left; padding-left: 8px; background: white; font-weight: bold;}
        .qr-box { width: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid #ddd; padding: 2px; background: #fff; }
        .qr-label { font-size: 8px; font-weight: bold; margin-top: 2px; color: #5a3d8c; }
        .class-box { width: 95px; border: 1px solid #444; display: flex; flex-direction: column; text-align: center; }
        .class-label { background: #5a3d8c; color: white; font-weight: bold; padding: 3px; font-size: 10px; }
        .class-val { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 26px; font-weight: bold; color: #5a3d8c; }
        .photo-box { width: 110px; border: 2px solid #5a3d8c; display: flex; align-items: center; justify-content: center; background: #fafafa; }
        .photo-box img { width: 100%; height: 100%; object-fit: cover; }
        .subject-table { margin-top: 8px; table-layout: fixed; width: 100%; }
        .subject-table th { background: #dcd0ff !important; font-size: 9.5px; height: 25px; }
        .subject-name { text-align: left; font-weight: bold; color: #b71c1c; padding-left: 8px; width: 135px; }
        .bottom-row-container { display: flex; gap: 10px; margin-top: 10px; flex-grow: 1; width: 100%; align-items: stretch; }
        .col-left { width: 220px; display: flex; flex-direction: column; gap: 8px; }
        .col-mid { flex: 1; display: flex; flex-direction: column; border: 1px solid #444; min-width: 0; }
        .col-right { width: 215px; display: flex; flex-direction: column; gap: 8px; }
        .section-box { border: 1px solid #444; display: flex; flex-direction: column; background: white; overflow: hidden; width: 100%; }
        .section-header { background: #5a3d8c !important; color: white !important; font-weight: bold; padding: 5px; text-align: center; font-size: 11px; }
        .remarks-content { padding: 8px; font-size: 10.5px; font-style: italic; flex-grow: 1; line-height: 1.3; }
        .chart-wrap { flex: 1; padding: 5px; position: relative; width: 100%; }
        .prof-row { display: flex; justify-content: space-between; padding: 6px 10px; border-bottom: 1px solid #eee; font-size: 10.5px; }
        .rank-bar { background: #37474f !important; color: white !important; padding: 8px; display: flex; justify-content: space-around; font-size: 10.5px; font-weight: bold; margin-top: auto; }
        .footer-sigs { display: flex; justify-content: space-between; margin-top: auto; padding-top: 10px; }
        .sig-block { width: 23%; text-align: center; }
        .sig-space { height: 35px; }
        .sig-label { border-top: 1.5px solid #000; padding-top: 4px; font-size: 11px; font-weight: bold; }
        .btn-download { position: fixed; bottom: 20px; right: 20px; padding: 12px 25px; background: #2e7d32; color: white; border: none; cursor: pointer; border-radius: 30px; font-weight: bold; z-index: 100; }
        @media print { .btn-download { display: none; } }
    </style>
</head>
<body>

<div class="printable-area">
    <div class="school-header outer-boundary">
        <img src="logo.png" class="school-logo" alt="Logo">
        <div class="header-text">
            <h1>GOVERNMENT PRIMARY SCHOOL</h1>
            <div class="header-address">Wagoora Babareshi Road Near ZEO Office Wagoora</div>
            <div style="font-size: 11px;">PETHGAM WAGOORA â€“ BARAMULLA, J&K (193109)</div>
        </div>
        <div class="header-right-contact">
            <div>Contact No: +91 7006261694</div>
            <div>UDISE Code: 01022202207</div>
            <div>Email Id: pspathgam@gmail.com</div>
        </div>
    </div>

    <div class="top-info-container outer-boundary">
        <div class="details-table">
            <table>
                <tr><td class="label-cell">Student Name:</td><td class="data-cell" id="sname" colspan="3"></td></tr>
                <tr><td class="label-cell">Adm. No:</td><td class="data-cell" id="admNoDisplay"></td><td class="label-cell">Roll No:</td><td class="data-cell" id="rollNo"></td></tr>
                <tr><td class="label-cell">Father's Name:</td><td class="data-cell" id="fname"></td><td class="label-cell">Mother's Name:</td><td class="data-cell" id="mname"></td></tr>
                <tr><td class="label-cell">Date of Birth:</td><td class="data-cell" id="dob"></td><td class="label-cell">Session:</td><td class="data-cell" id="session"></td></tr>
                <tr><td class="label-cell">Apaar Id:</td><td class="data-cell" id="apaar"></td><td class="label-cell">PEN No:</td><td class="data-cell" id="penDisplay"></td></tr>
            </table>
        </div>
        <div class="qr-box"><div id="qrcode"></div><div class="qr-label">SCAN TO VERIFY</div></div>
        <div class="class-box"><div class="class-label">CLASS</div><div class="class-val" id="classVal">--</div></div>
        <div class="photo-box" id="photoBox"><span>Photo</span></div>
    </div>

    <table class="subject-table outer-boundary">
        <thead>
            <tr>
                <th class="subject-name">Subject</th>
                <th>FA1</th><th>FA2</th><th>FA3</th><th>FA4</th><th>FA5</th><th>FA6</th>
                <th>Total(30)</th><th>CCA(20)</th><th>SA(50)</th>
                <th>Total(100)</th><th>Grade</th><th>Proficiency</th>
            </tr>
        </thead>
        <tbody id="marksBody"></tbody>
        <tr style="background:#f1f8e9 !important; font-weight:bold;">
            <td style="text-align:right; padding-right:10px;">Grand Totals:</td>
            <td id="gtFa1">0</td><td id="gtFa2">0</td><td id="gtFa3">0</td><td id="gtFa4">0</td><td id="gtFa5">0</td><td id="gtFa6">0</td>
            <td id="gt30">0</td><td id="gt20">0</td><td id="gt50">0</td>
            <td id="gt100">0</td>
            <td id="finalGrade" style="color:#b71c1c;">-</td>
            <td id="finalProf" style="color:#b71c1c;">-</td>
        </tr>
    </table>

    <div class="bottom-row-container outer-boundary">
        <div class="col-left">
            <div class="section-box" style="height: 125px;">
                <div class="section-header" style="background:#b71c1c !important;">Co-Scholastic Record</div>
                <table>
                    <tr><td style="text-align:left;">Attendance %</td><td id="att" width="55"></td></tr>
                    <tr><td style="text-align:left;">Discipline</td><td>A</td></tr>
                    <tr><td style="text-align:left;">Sports / Health</td><td>B</td></tr>
                    <tr><td style="text-align:left;">Art and Craft</td><td>A</td></tr>
                </table>
            </div>
            <div class="section-box" style="flex: 1;"><div class="section-header">General Remarks</div><div class="remarks-content" id="remarksText"></div></div>
        </div>
        <div class="col-mid"><div class="section-header" style="background:#ff9800 !important;">Performance Chart</div><div class="chart-wrap"><canvas id="marksChart"></canvas></div></div>
        <div class="col-right">
            <div class="section-box" style="height: 110px;">
                <div class="section-header">Final Result Summary</div>
                <table style="height: 100%;">
                    <tr><td class="label-cell">Total Marks:</td><td id="resTotal" style="font-weight:bold;"></td></tr>
                    <tr><td class="label-cell">Percentage:</td><td id="resPerc"></td></tr>
                    <tr><td class="label-cell">Result:</td><td id="resFinal" style="color:green; font-weight:bold;">PASS</td></tr>
                </table>
            </div>
            <div class="section-box" style="flex: 1;">
                <div class="section-header" style="background:#ef5350 !important;">Level of Proficiency</div>
                <div class="prof-row"><span>Sky (Excellent)</span><b id="pSky"></b></div>
                <div class="prof-row"><span>Mountain (Good)</span><b id="pMtn"></b></div>
                <div class="prof-row"><span>Stream (Average)</span><b id="pStrm"></b></div>
                <div class="rank-bar"><span>School Rank: <span id="sRank">--</span></span><span>Class Rank: <span id="cRank">--</span></span></div>
            </div>
        </div>
    </div>

    <div class="footer-sigs outer-boundary">
        <div class="sig-block"><div class="sig-space"></div><div class="sig-label">Class Teacher</div></div>
        <div class="sig-block"><div class="sig-space"></div><div class="sig-label">Exam In-Charge</div></div>
        <div class="sig-block"><div class="sig-space"></div><div class="sig-label">Parent/Guardian</div></div>
        <div class="sig-block"><div class="sig-space"></div><div class="sig-label">Headmaster Seal/Sign</div></div>
    </div>
</div>

<button class="btn-download" onclick="window.print()">Print Marksheet</button>

<script type="module">
    // 1. Import Firebase dependencies
    import { db } from './init-firebase.js';
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 2. Main Logic on Load
    window.addEventListener('DOMContentLoaded', async () => {
        const params = new URLSearchParams(window.location.search);
        const studentId = params.get('id');
        
        // Set dates
        const today = new Date().toLocaleDateString('en-GB');
        if(document.getElementById("todayDate")) document.getElementById("todayDate").value = today;
        if(document.getElementById("consentDate")) document.getElementById("consentDate").value = today;

        if (studentId) {
            try {
                // Fetch specific student document from the "admissions" collection
                const docRef = doc(db, "admissions", studentId.trim());
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const student = docSnap.data();
                    
                    // Fill display elements
                    if(document.getElementById("displayAdmNo")) document.getElementById("displayAdmNo").innerText = student.admNo;
                    if(document.getElementById("studentNameDisplay")) document.getElementById("studentNameDisplay").value = student.studentName;
                    if(document.getElementById("studentNameHOI")) document.getElementById("studentNameHOI").value = student.studentName;
                    if(document.getElementById("parentNameInput")) document.getElementById("parentNameInput").value = student.fatherName || "";
                    
                    // Specific logic for Aadhaar
                    if(document.getElementById("parentAadhaarInput") && student.aadhaarNo) {
                        document.getElementById("parentAadhaarInput").value = student.aadhaarNo;
                    }
                } else {
                    console.error("No such student record found in Firebase!");
                }
            } catch (error) {
                console.error("Error fetching student data:", error);
            }
        }
    });

    // 3. Attach Download function to window so the button can still find it
    window.downloadPDF = function() {
        const studentName = document.getElementById("studentNameDisplay")?.value || "Student";
        const filename = "APAAR_Consent_" + studentName.replace(/\s+/g, '_') + ".pdf";
        const originalTitle = document.title;
        document.title = filename;
        window.print();
        document.title = originalTitle;
    };
</script>

</body>
</html>
