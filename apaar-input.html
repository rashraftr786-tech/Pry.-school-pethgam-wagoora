<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Step 2: APAAR ID Generation Consent</title>
    <style>
        :root { --primary: #f57f17; --bg: #fffde7; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; line-height: 1.5; }
        .consent-card { max-width: 850px; margin: auto; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 10px solid var(--primary); }
        
        .header-text { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .header-text h2 { margin: 0; color: #333; font-size: 20px; text-transform: uppercase; }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
        .full { grid-column: span 2; }
        
        label { display: block; font-weight: bold; font-size: 13px; margin-bottom: 5px; color: #555; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        
        .legal-scroll { height: 250px; overflow-y: scroll; background: #f9f9f9; padding: 20px; border: 1px solid #ddd; font-size: 13px; text-align: justify; margin: 20px 0; border-radius: 5px; }
        .legal-scroll p { margin: 0 0 10px 0; }

        .checkbox-container { background: #fff9c4; padding: 15px; border-radius: 8px; display: flex; align-items: flex-start; gap: 10px; cursor: pointer; border: 1px solid #fbc02d; }
        .checkbox-container input { width: auto; margin-top: 4px; }

        .btn-finish { background: var(--primary); color: white; width: 100%; padding: 18px; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 25px; transition: 0.3s; }
        .btn-finish:hover { background: #e65100; transform: translateY(-2px); }
    </style>
</head>
<body>

<div class="consent-card">
    <div class="header-text">
        <h2>Consent by Father/Mother/Legal Guardian</h2>
        <p style="font-size: 14px; font-weight: bold; color: var(--primary);">For APAAR ID Generation</p>
    </div>

    <form id="apaarForm">
        <div class="form-row">
            <div class="full">
                <label>Name of Parent/Guardian (I, ...)</label>
                <input type="text" id="parentName" required placeholder="Full Name of Father/Mother">
            </div>
            <div>
                <label>Relationship with Student</label>
                <select id="relation" required>
                    <option value="Father">Father</option>
                    <option value="Mother">Mother</option>
                    <option value="Legal Guardian">Legal Guardian</option>
                </select>
            </div>
            <div>
                <label>Name of the Student</label>
                <input type="text" id="studentDisplay" disabled style="background: #eee;">
            </div>
        </div>

        <div class="form-row">
            <div>
                <label>Identity Proof Type</label>
                <select id="idType">
                    <option>Aadhaar</option><option>PAN</option><option>Voter ID</option><option>Passport</option>
                </select>
            </div>
            <div>
                <label>Identity Proof Number (Aadhaar No. of Parent)</label>
                <input type="text" id="idNumber" required maxlength="12">
            </div>
        </div>

        <div class="legal-scroll">
            <p>I voluntarily give my consent to share his/her Aadhaar Number and demographic information issued by UIDAI with Ministry of Education for the sole purpose of creation of APAAR ID and opening of DIGILOCKER account of my child for the following intents and purposes.</p>
            <p>I understand that my APAAR ID may be used and shared for limited purposes as may be notified by Ministry of Education from time to time for educational and related activities. Further I am also aware that my personal identifiable information (Name, Address, Age, Date of Birth, Gender and Photograph) may be made available to entities engaged in various educational activities such as UDISE+ database, scholarships, maintenance academic records, other stakeholders like Educational Institutions and recruitment agencies.</p>
            <p>I authorise Ministry of Education to use my Aadhaar number for performing Aadhaar based authentication with UIDAI as per provision of the Aadhaar Act, 2016. I understand that UIDAI will share my e-KYC details upon successful authentication.</p>
            <p>I understand that the information shared by me shall be kept Confidential and shall not be divulged to any third party except as may be required by law. I understand that I can withdraw my consent at any time.</p>
        </div>

        <label class="checkbox-container">
            <input type="checkbox" id="agree" required>
            <span>I <strong>Mohmad Ashraf Rather</strong> (Head of School) and the Parent/Guardian hereby declare and give consent for providing AADHAAR to create APAAR ID and Identity Verification in UDISE Plus.</span>
        </label>

        <button type="button" class="btn-finish" onclick="finalize()">Finalize & Generate 7-Page Dossier âž”</button>
    </form>
</div>

<script>
    // Load student name from Step 1 automatically
    window.onload = function() {
        const step1 = JSON.parse(localStorage.getItem('temp_adm'));
        if (step1 && step1.sname) {
            document.getElementById('studentDisplay').value = step1.sname;
            document.getElementById('parentName').value = step1.fname || "";
        }
    };

    async function finalize() {
    console.log("Button Clicked..."); // Check if button is even working

    const agreeBox = document.getElementById('agree');
    const idNum = document.getElementById('idNumber').value;

    // 1. Validation Check
    if(!agreeBox.checked) {
        alert("Action Required: Please check the consent declaration box.");
        return;
    }
    if(!idNum) {
        alert("Action Required: Please enter the Parent's Identity Number.");
        return;
    }

    try {
        // 2. Data Retrieval Check
        // IMPORTANT: Ensure this matches the key used in admission.html
        const rawData = localStorage.getItem('temp_adm'); 
        if (!rawData) {
            alert("Error: No data found from Step 1. Please go back and fill the Admission Form again.");
            return;
        }
        
        const step1 = JSON.parse(rawData);
        console.log("Step 1 Data Loaded:", step1);

        // 3. Combine Data
        const finalDossierData = {
            ...step1,
            parentConsentName: document.getElementById('parentName').value,
            parentRelation: document.getElementById('relation').value,
            parentIdNumber: idNum,
            consentDate: new Date().toLocaleDateString(),
            status: "Complete"
        };

        // 4. Storage Check
        localStorage.setItem('admissionData', JSON.stringify(finalDossierData));
        localStorage.setItem('temp_adm', JSON.stringify(finalDossierData)); // Overwrite with full data

        console.log("Redirecting to full-dossier.html...");
        
        // 5. Final Redirect
        window.location.href = 'full-dossier.html';

    } catch (error) {
        console.error("Execution Error:", error);
        alert("A technical error occurred: " + error.message);
    }
}

</script>

</body>
</html>

