<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign In | GPS Pethgam Cloud</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
  <style>
    :root { --primary: #1b5e20; }
    body { background: linear-gradient(135deg, #f0f2f5 0%, #c2e9fb 100%); min-height: 100-vh; }
    .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
    .btn-3d { 
        box-shadow: 0 4px 0 #144614; transition: all 0.1s; 
    }
    .btn-3d:active { transform: translateY(4px); box-shadow: 0 0 0 #144614; }
    #recaptcha-container { margin: 10px 0; }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

  <div class="glass w-full max-auto max-w-md rounded-3xl shadow-2xl overflow-hidden">
    <div class="bg-emerald-800 p-8 text-white text-center">
      <div class="bg-white w-16 h-16 rounded-full mx-auto mb-4 flex items-center justify-center shadow-lg">
        <span class="material-icons-outlined text-emerald-800 text-3xl">lock</span>
      </div>
      <h1 class="text-2xl font-black tracking-tight">CLOUD SECURE LOGIN</h1>
      <p class="text-emerald-200 text-xs mt-1">Unified ERP Access Portal</p>
    </div>

    <div class="p-8">
      <div class="flex bg-gray-100 p-1 rounded-xl mb-6">
        <button onclick="setRole('parent')" id="role-parent" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all bg-white shadow text-emerald-800">PARENT</button>
        <button onclick="setRole('staff')" id="role-staff" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all text-gray-500">STAFF</button>
        <button onclick="setRole('admin')" id="role-admin" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all text-gray-500">ADMIN</button>
      </div>

      <div id="step-phone" class="space-y-4">
        <div>
          <label class="block text-[10px] font-black text-gray-400 uppercase ml-1">Mobile Number</label>
          <div class="flex items-center border-b-2 border-gray-200 focus-within:border-emerald-600 transition-all">
            <span class="text-gray-400 font-bold px-2">+91</span>
            <input type="tel" id="phoneNumber" placeholder="9906XXXXXX" class="w-full p-3 bg-transparent outline-none font-bold text-lg tracking-widest">
          </div>
        </div>

        <div id="recaptcha-container"></div>

        <button onclick="onSignInSubmit()" class="btn-3d w-full bg-emerald-700 text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2">
          SEND OTP <span class="material-icons-outlined">arrow_forward</span>
        </button>
      </div>

      <div id="step-otp" class="space-y-4 hidden">
        <div class="text-center">
          <p class="text-sm text-gray-500">Enter the 6-digit code sent to your phone</p>
        </div>
        <input type="text" id="otpCode" placeholder="· · · · · ·" class="w-full p-4 bg-gray-50 border-2 border-emerald-100 rounded-xl text-center text-2xl font-black tracking-[1em] outline-none focus:border-emerald-500">
        
        <button onclick="verifyOtp()" class="btn-3d w-full bg-indigo-700 text-white font-bold py-4 rounded-xl">
          VERIFY & LOGIN
        </button>
        <button onclick="location.reload()" class="w-full text-xs text-gray-400 font-bold uppercase">Back to Change Number</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // Same config as your ERP
    const firebaseConfig = {
      apiKey: "AIzaSyCzxHme_3hrztrDuD7wupGwNilDtYLfENI",
      authDomain: "studio-2729610945-4684b.firebaseapp.com",
      projectId: "studio-2729610945-4684b",
      storageBucket: "studio-2729610945-4684b.firebasestorage.app",
      messagingSenderId: "711147405574",
      appId: "1:711147405574:web:7b5597955b676a3e4d1e87"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    let selectedRole = 'parent';

    // Role Switcher Logic
    window.setRole = (role) => {
      selectedRole = role;
      document.querySelectorAll('.flex button').forEach(btn => {
        btn.classList.remove('bg-white', 'shadow', 'text-emerald-800');
        btn.classList.add('text-gray-500');
      });
      const activeBtn = document.getElementById(`role-${role}`);
      activeBtn.classList.add('bg-white', 'shadow', 'text-emerald-800');
      activeBtn.classList.remove('text-gray-500');
    };

    // Setup Recaptcha
    window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
      'size': 'normal'
    });

    // Step 1: Submit Phone
    window.onSignInSubmit = function() {
      const number = "+91" + document.getElementById('phoneNumber').value;
      const appVerifier = window.recaptchaVerifier;

      signInWithPhoneNumber(auth, number, appVerifier)
        .then((confirmationResult) => {
          window.confirmationResult = confirmationResult;
          document.getElementById('step-phone').classList.add('hidden');
          document.getElementById('step-otp').classList.remove('hidden');
        }).catch((error) => {
          alert("Error: Check phone number format or Recaptcha");
          console.error(error);
        });
    }

    // Step 2: Verify OTP
    window.verifyOtp = function() {
      const code = document.getElementById('otpCode').value;
      window.confirmationResult.confirm(code).then((result) => {
        const user = result.user;
        console.log("Logged in as:", user.phoneNumber);
        
        // Redirection Logic based on Role
        if(selectedRole === 'admin') window.location.href = "admin-dashboard.html";
        else if(selectedRole === 'staff') window.location.href = "staff-entry.html";
        else window.location.href = "student-diary-parent.html";

      }).catch((error) => {
        alert("Invalid OTP Code!");
      });
    }
  </script>
</body>
</html>
