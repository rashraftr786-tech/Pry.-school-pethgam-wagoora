<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Staff Entry | GPS Pethgam Wagoora</title>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
    .container { max-width: 850px; background: white; margin: auto; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    
    header { border-bottom: 2px solid #1a5d1a; margin-bottom: 25px; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    header h2 { color: #1a5d1a; margin: 0; }
    .btn-view { text-decoration: none; background: #1a5d1a; color: white; padding: 8px 15px; border-radius: 4px; font-size: 14px; font-weight: bold; }

    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .full-width { grid-column: span 2; }

    .photo-section {
      background: #f9f9f9;
      border: 2px dashed #1a5d1a;
      padding: 15px;
      display: flex;
      align-items: center;
      gap: 20px;
      border-radius: 6px;
    }
    #staffPhotoPreview { 
      width: 100px; height: 120px; 
      border: 2px solid #1a5d1a; 
      object-fit: cover; 
      display: none; 
      background: #eee;
    }

    .input-group { display: flex; flex-direction: column; gap: 5px; }
    label { font-weight: bold; color: #333; font-size: 13px; }
    input, select, textarea { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
    input:focus { border-color: #1a5d1a; outline: none; box-shadow: 0 0 5px rgba(26,93,26,0.2); }

    .submit-btn { 
      background: #1a5d1a; color: white; border: none; padding: 15px; 
      font-size: 16px; font-weight: bold; border-radius: 4px; cursor: pointer; 
      margin-top: 20px; width: 100%; transition: 0.3s;
    }
    .submit-btn:hover { background: #144614; }
    .submit-btn:disabled { background: #ccc; cursor: not-allowed; }

    @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } .full-width { grid-column: span 1; } }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h2>Staff Registration</h2>
    <a href="staff-statement.html" class="btn-view">ðŸ“„ View Staff Statement</a>
  </header>

  <form id="staffForm">
    <div class="form-grid">
      <div class="photo-section full-width">
        <div style="flex: 1;">
          <label>Staff Photograph</label><br>
          <input type="file" id="staffPhoto" accept="image/*" onchange="processStaffPhoto(event)">
          <p style="font-size: 11px; color: #666; margin-top: 5px;">Photo is auto-compressed for cloud storage.</p>
        </div>
        <img id="staffPhotoPreview" alt="Preview">
      </div>

      <div class="input-group full-width">
        <label for="name">Full Name (as per Service Book)</label>
        <input type="text" id="name" placeholder="Enter Full Name" required>
      </div>

      <div class="input-group">
        <label for="designation">Designation</label>
        <select id="designation">
          <option value="">--Select--</option>
          <option value="Headmaster">Headmaster</option>
          <option value="Teacher">Teacher</option>
          <option value="Grade-II Teacher">Grade-II Teacher</option>
          <option value="Grade-III Teacher">Grade-III Teacher</option>
          <option value="RReT">RReT</option>
          <option value="MTW">MTW</option>
        </select>
      </div>

      <div class="input-group">
        <label for="qualification">Educational Qualification</label>
        <input type="text" id="qualification" placeholder="e.g., M.A, B.Ed">
      </div>

      <div class="input-group">
        <label for="subjectPG">Subject in P.G</label>
        <input type="text" id="subjectPG" placeholder="e.g., Urdu, History, N/A">
      </div>

      <div class="input-group">
        <label for="contact">Contact Number</label>
        <input type="tel" id="contact" placeholder="10-digit Number">
      </div>

      <div class="input-group">
        <label for="doFirstAppt">Date of 1st Appointment</label>
        <input type="date" id="doFirstAppt">
      </div>

      <div class="input-group">
        <label for="dojPresentSchool">D.O.J (Present School)</label>
        <input type="date" id="dojPresentSchool">
      </div>

      <div class="input-group full-width">
        <label for="actualPosting">Actual Place of Posting (If deployed/detached)</label>
        <input type="text" id="actualPosting" placeholder="Enter School Name or 'N/A'">
      </div>

      <div class="input-group full-width">
        <label for="remarks">Remarks</label>
        <textarea id="remarks" rows="2" placeholder="Any additional details..."></textarea>
      </div>
    </div>

    <button type="button" class="submit-btn" onclick="saveStaff()">Save Staff Record to Cloud</button>
  </form>
</div>



<script type="module">
  import { db } from './init-firebase.js';
  import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  let compressedPhotoBase64 = "";

  // Handle Photo Processing
  window.processStaffPhoto = function(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement('canvas');
        const MAX_WIDTH = 150; 
        const scaleSize = MAX_WIDTH / img.width;
        canvas.width = MAX_WIDTH;
        canvas.height = img.height * scaleSize;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        
        compressedPhotoBase64 = canvas.toDataURL('image/jpeg', 0.6); // 60% quality to save space
        const preview = document.getElementById("staffPhotoPreview");
        preview.src = compressedPhotoBase64;
        preview.style.display = "block";
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  // Save to Firebase
  window.saveStaff = async function() {
    const btn = document.querySelector('.submit-btn');
    const nameInput = document.getElementById('name');

    if (!nameInput.value.trim()) {
      alert("Please enter the Staff Name.");
      return;
    }

    btn.disabled = true;
    btn.innerText = "Uploading to Firebase...";

    const staffData = {
      name: nameInput.value,
      designation: document.getElementById('designation').value,
      qualification: document.getElementById('qualification').value,
      subjectPG: document.getElementById('subjectPG').value,
      doFirstAppt: document.getElementById('doFirstAppt').value,
      dojPresentSchool: document.getElementById('dojPresentSchool').value,
      actualPosting: document.getElementById('actualPosting').value || "N.A.",
      contact: document.getElementById('contact').value,
      remarks: document.getElementById('remarks').value,
      photo: compressedPhotoBase64, // The compressed image string
      createdAt: serverTimestamp()
    };

    try {
      await addDoc(collection(db, "staffRecords"), staffData);
      alert("Staff Record Saved Successfully!");
      document.getElementById('staffForm').reset();
      document.getElementById('staffPhotoPreview').style.display = 'none';
      compressedPhotoBase64 = "";
    } catch (error) {
      console.error("Firebase Error:", error);
      alert("Error saving record. Check your internet connection.");
    } finally {
      btn.disabled = false;
      btn.innerText = "Save Staff Record to Cloud";
    }
  }
</script>

</body>
</html>

