<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MDM Dashboard - GPS Pethgam Wagoora</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root { --primary: #1a5d1a; --secondary: #5a3d8c; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 500px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2, h3 { margin-top: 0; color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 8px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 13px; color: #444; }
        input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        .btn { width: 100%; padding: 14px; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.3s; }
        .btn-save { background: var(--primary); }
        .btn-settings { background: var(--secondary); margin-top: 10px; }
        .btn:active { transform: scale(0.98); }
        .stats-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .stat-item { flex: 1; background: #e8f5e9; padding: 10px; border-radius: 6px; text-align: center; }
        .stat-label { font-size: 10px; color: #666; text-transform: uppercase; }
        .stat-val { font-size: 18px; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2>Daily MDM Entry</h2>
        <div class="input-group">
            <label>Reporting Date</label>
            <input type="date" id="logDate">
        </div>
        <div class="stats-row">
            <div class="input-group" style="flex:1">
                <label>Pre-Primary</label>
                <input type="number" id="prePriCount" placeholder="0">
            </div>
            <div class="input-group" style="flex:1">
                <label>Primary</label>
                <input type="number" id="priCount" placeholder="0">
            </div>
        </div>
        <div class="input-group">
            <label>Rice Lifted (in Kg)</label>
            <input type="number" id="grainsLifted" step="0.001" value="0">
        </div>
        <div class="input-group">
            <label>Funds Received (â‚¹)</label>
            <input type="number" id="fundsReceived" step="0.01" value="0">
        </div>
        <button class="btn btn-save" onclick="saveMDM()">Save Daily Record</button>
    </div>

    <div class="card" style="border-top: 5px solid var(--secondary);">
        <h3>Expenditure Settings</h3>
        <div class="input-group">
            <label>Current Cooking Cost (â‚¹ per student)</label>
            <input type="number" id="configRate" step="0.01">
        </div>
        <div class="input-group">
            <label>Grain Scale (Fixed: 100g)</label>
            <input type="text" value="0.100 Kg" disabled style="background: #f9f9f9;">
        </div>
        <button class="btn btn-settings" onclick="saveSettings()">Update Expenditure Rate</button>
    </div>
    
    <div style="text-align: center;">
        <a href="mdm-statement.html" style="text-decoration: none; color: var(--secondary); font-weight: bold;">ðŸ“Š Generate Monthly Statement</a>
    </div>
</div>

<script type="module">
    // 1. Firebase Imports
    import { db } from './init-firebase.js';
    import { doc, getDoc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Initialize date
    document.getElementById('logDate').valueAsDate = new Date();

    // 2. Fetch Configuration and Sync Roll on Load
    window.addEventListener('DOMContentLoaded', async () => {
        // Fetch MDM Rate from a "settings" collection
        try {
            const configRef = doc(db, "settings", "mdm_config");
            const configSnap = await configDoc(configRef);
            if (configSnap.exists()) {
                document.getElementById('configRate').value = configSnap.data().rate || 5.45;
            }
        } catch (e) { console.error("Config fetch error:", e); }

        await syncRollFromAdmissions();
    });

    // 3. Save Settings (Meal Rate) to Cloud
    window.saveSettings = async function() {
        const rate = document.getElementById('configRate').value;
        try {
            await setDoc(doc(db, "settings", "mdm_config"), { 
                rate: parseFloat(rate),
                updatedAt: new Date().toISOString()
            });
            alert("System updated in Cloud. Expenditure set to â‚¹" + rate);
        } catch (e) { alert("Error updating settings."); }
    };

    // 4. Sync Roll from Admissions Collection
    async function syncRollFromAdmissions() {
        try {
            const q = collection(db, "admissions");
            const querySnapshot = await getDocs(q);
            let students = [];
            querySnapshot.forEach(doc => students.push(doc.data()));

            const prePrimaryRoll = students.filter(s => 
                s.studentClass === "Bal-Vatika" || s.studentClass === "Pre-Primary"
            ).length;

            const primaryRoll = students.filter(s => 
                ["1st", "2nd", "3rd", "4th", "5th"].includes(s.studentClass)
            ).length;

            if(document.getElementById('rollPP')) document.getElementById('rollPP').value = prePrimaryRoll;
            if(document.getElementById('rollP')) document.getElementById('rollP').value = primaryRoll;
            
            console.log(`Cloud Roll Synced: PP=${prePrimaryRoll}, P=${primaryRoll}`);
        } catch (e) { console.error("Roll sync error:", e); }
    }

    // 5. Save Daily MDM Log to Cloud
    window.saveMDM = async function() {
        const date = document.getElementById('logDate').value;
        if(!date) return alert("Select a date");

        const prePri = parseInt(document.getElementById('prePriCount').value) || 0;
        const pri = parseInt(document.getElementById('priCount').value) || 0;
        const lifted = parseFloat(document.getElementById('grainsLifted').value) || 0;
        const funds = parseFloat(document.getElementById('fundsReceived').value) || 0;
        const currentRate = parseFloat(document.getElementById('configRate').value) || 5.45;

        const record = {
            date,
            prePriCount: prePri,
            priCount: pri,
            grainsLifted: lifted,
            fundsReceived: funds,
            grainsUtilized: (prePri + pri) * 0.100, // 100g per student
            fundsUtilized: (prePri + pri) * currentRate,
            timestamp: new Date().toISOString()
        };

        try {
            // Using date as the ID ensures one entry per day
            await setDoc(doc(db, "mdmDailyLogs", date), record);
            alert("Data successfully synced to Cloud for " + date);
            
            document.getElementById('prePriCount').value = "";
            document.getElementById('priCount').value = "";
        } catch (e) {
            console.error("Save error:", e);
            alert("Cloud sync failed.");
        }
    };
</script>

</body>
</html>

