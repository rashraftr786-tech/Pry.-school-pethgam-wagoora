<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Ledger | GPS Pethgam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .custom-scrollbar::-webkit-scrollbar { height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .field-label { font-size: 9px; text-transform: uppercase; color: #94a3b8; font-weight: 800; display: block; margin-bottom: 2px; }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #1e40af; }
    </style>
</head>
<body class="bg-white font-sans p-4">

    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
        <div>
            <h1 class="text-xl font-black text-slate-800 uppercase italic">Master Student Ledger</h1>
            <div class="flex gap-4 mt-2">
                <button onclick="switchTab('active')" id="tabActive" class="text-xs font-bold uppercase tracking-wider pb-1 tab-active">Active Students</button>
                <button onclick="switchTab('pending')" id="tabPending" class="text-xs font-bold uppercase tracking-wider pb-1 text-slate-400 relative">
                    Pending Approvals
                    <span id="pendingBadge" class="absolute -top-2 -right-4 bg-red-500 text-white text-[8px] px-1 rounded-full hidden">0</span>
                </button>
            </div>
        </div>
        <div class="flex gap-2 w-full md:w-auto">
            <input type="text" id="ledgerSearch" placeholder="Search by Aadhaar, PEN, or Name..." class="flex-1 bg-slate-100 border-none rounded-xl px-4 py-2 text-xs focus:ring-2 focus:ring-blue-500 outline-none">
        </div>
    </div>

    <div class="overflow-x-auto custom-scrollbar border border-slate-100 rounded-3xl shadow-sm">
        <table class="w-full text-left min-w-[1800px]">
            <thead class="bg-slate-50 border-b border-slate-100">
                <tr class="text-[10px] font-black uppercase text-slate-400 tracking-tighter">
                    <th class="p-4">Photo</th>
                    <th class="p-4">1. Identity (Name/Aadhaar)</th>
                    <th class="p-4">2. Family (Father/Mother)</th>
                    <th class="p-4">3. Location (DOB/Residence)</th>
                    <th class="p-4">4. Official (PEN/Apaar/Bank)</th>
                    <th class="p-4" id="colStatusHeader">5. Admission Status</th>
                    <th class="p-4 text-center">Actions</th>
                </tr>
            </thead>
            <tbody id="ledgerBody" class="text-[11px] font-bold text-slate-600">
                </tbody>
        </table>
    </div>

    <script type="module">
        import { db } from '../../assets/js/firebase.js';
        import { collection, query, where, onSnapshot, doc, updateDoc, deleteDoc, setDoc, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let currentTab = 'active';

        // --- 1. LIVE DATA SYNC ---
        window.switchTab = (tab) => {
            currentTab = tab;
            document.getElementById('tabActive').classList.toggle('tab-active', tab === 'active');
            document.getElementById('tabPending').classList.toggle('tab-active', tab === 'pending');
            loadData();
        };

        async function loadData() {
            const collectionName = currentTab === 'active' ? "students" : "pending_admissions";
            const q = query(collection(db, collectionName));

            onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById('ledgerBody');
                tbody.innerHTML = '';
                
                // Update Pending Badge
                if(currentTab === 'active') {
                    // Check pending count for badge
                    getDocs(query(collection(db, "pending_admissions"))).then(snap => {
                        const badge = document.getElementById('pendingBadge');
                        badge.innerText = snap.size;
                        badge.classList.toggle('hidden', snap.size === 0);
                    });
                }

                snapshot.forEach((docSnap) => {
                    const s = docSnap.data();
                    const id = docSnap.id;
                    
                    const row = `
                        <tr class="border-b border-slate-50 hover:bg-slate-50/80 transition-all">
                            <td class="p-4">
                                <div class="w-12 h-12 bg-slate-100 rounded-2xl border-2 border-white shadow-sm overflow-hidden">
                                    <img src="${s.photo || 'https://via.placeholder.com/150'}" class="w-full h-full object-cover">
                                </div>
                            </td>
                            <td class="p-4">
                                <span class="field-label">Full Name / Admission No</span>
                                <p class="text-slate-900 uppercase font-black text-sm">${s.fullName}</p>
                                <p class="text-blue-600 mb-1">${s.admissionNo || 'WAITING APPROVAL'}</p>
                                <span class="field-label">Aadhaar / Category</span>
                                <p class="text-[10px]"># ${s.aadhaar || 'N/A'} | ${s.category || 'N/A'}</p>
                            </td>
                            <td class="p-4">
                                <span class="field-label">Father's Name</span>
                                <p class="uppercase">${s.fatherName || 'N/A'}</p>
                                <span class="field-label mt-2">Mother's Name</span>
                                <p class="uppercase">${s.motherName || 'N/A'}</p>
                            </td>
                            <td class="p-4">
                                <span class="field-label">DOB</span>
                                <p>${s.dob || 'N/A'}</p>
                                <span class="field-label mt-2">Residence</span>
                                <p class="uppercase tracking-tighter">${s.residence || 'N/A'}</p>
                            </td>
                            <td class="p-4">
                                <div class="grid grid-cols-2 gap-x-4">
                                    <div><span class="field-label">Bank Acc</span><p>${s.bankAcc || 'N/A'}</p></div>
                                    <div><span class="field-label">PEN</span><p>${s.pen || 'N/A'}</p></div>
                                </div>
                            </td>
                            <td class="p-4 text-center">
                                ${currentTab === 'active' ? 
                                    `<span class="bg-emerald-100 text-emerald-700 px-3 py-1 rounded-lg text-[8px] uppercase font-black">Verified Student</span>` : 
                                    `<span class="bg-amber-100 text-amber-700 px-3 py-1 rounded-lg text-[8px] uppercase font-black">Pending Review</span>`
                                }
                            </td>
                            <td class="p-4">
                                <div class="flex flex-col gap-2">
                                    ${currentTab === 'pending' ? 
                                        `<button onclick="approveStudent('${id}')" class="bg-blue-600 text-white p-2 rounded-xl text-[10px] font-black uppercase hover:bg-emerald-600"><i class="fa-solid fa-check-double"></i> Approve & Allot ID</button>
                                         <button onclick="rejectStudent('${id}')" class="bg-red-50 text-red-600 p-2 rounded-xl text-[10px] font-black uppercase hover:bg-red-600 hover:text-white border border-red-100"><i class="fa-solid fa-trash"></i> Reject</button>` : 
                                        `<button class="bg-slate-100 p-2 rounded-xl hover:bg-blue-600 hover:text-white text-[10px] font-black uppercase"><i class="fa-solid fa-eye"></i> Profile</button>`
                                    }
                                </div>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });
        }

        // --- 2. APPROVAL LOGIC (Moving data + Auto ID) ---
        window.approveStudent = async (docId) => {
            if(!confirm("Approve this student and allot Admission Number?")) return;
            
            try {
                // Get sequential count for ID allotment
                const masterSnap = await getDocs(collection(db, "students"));
                const nextNo = (masterSnap.size + 1).toString().padStart(3, '0');
                const year = new Date().getFullYear();
                const autoID = `${year}/PETH/${nextNo}`;

                // Get pending data
                const pendingRef = doc(db, "pending_admissions", docId);
                const snap = await getDocs(query(collection(db, "pending_admissions"))); 
                // (Optimized: in real use, fetch specifically the docId)
                
                // Move to Active Database
                const studentRef = doc(db, "students", docId);
                // Note: You'd fetch actual doc data here
                alert("Processing Allotment for ID: " + autoID);
                
                // Actual implementation would copy fields...
                // await setDoc(studentRef, {...data, admissionNo: autoID});
                // await deleteDoc(pendingRef);

            } catch (error) {
                alert("Error: " + error.message);
            }
        };

        window.rejectStudent = async (docId) => {
            if(confirm("Are you sure you want to reject and delete this application?")) {
                await deleteDoc(doc(db, "pending_admissions", docId));
            }
        };

        loadData();
    </script>
</body>
</html>

