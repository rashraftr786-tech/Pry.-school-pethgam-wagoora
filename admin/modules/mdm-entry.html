<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MDM Expenditure Statement | GPS Pethgam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; }
            #reportContainer { border: none !important; box-shadow: none !important; width: 100%; }
        }
        table { width: 100%; border-collapse: collapse; font-size: 10px; }
        th, td { border: 1px solid black; padding: 3px; text-align: center; }
        .vertical-text { writing-mode: vertical-rl; transform: rotate(180deg); font-weight: bold; }
    </style>
</head>
<body class="bg-slate-100 p-4">

    <div class="max-w-6xl mx-auto bg-white p-6 rounded-3xl shadow-sm mb-8 no-print border-2 border-emerald-100">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h2 class="text-xl font-black text-emerald-700 uppercase tracking-tighter">MDM Official Report Generator</h2>
                <p class="text-[10px] text-slate-400 font-bold uppercase italic">Auto-calculates balances from previous months</p>
            </div>
            <div class="flex gap-3">
                <input type="month" id="reportMonth" class="p-3 bg-slate-50 rounded-xl outline-none border text-sm font-bold" onchange="fetchCurrentMonthData()">
                <button onclick="window.print()" class="bg-slate-800 text-white px-6 py-2 rounded-xl font-bold uppercase text-xs hover:bg-emerald-600 transition-all">
                    <i class="fa-solid fa-print mr-2"></i> Print
                </button>
            </div>
        </div>
    </div>

    <div id="reportContainer" class="max-w-[1100px] mx-auto bg-white p-10 shadow-2xl border border-slate-300">
        <div class="flex items-center justify-between mb-4 border-b-2 border-black pb-2">
            <img src="../../assets/logo.png" class="w-16 h-16 object-contain" alt="Logo">
            <div class="text-center flex-1">
                <p class="italic text-xs font-serif">Office of the Headmaster</p>
                <h1 class="text-xl font-bold tracking-tight uppercase">Government Primary School Pethgam Wagoora</h1>
                <h3 class="text-[11px] font-bold uppercase tracking-widest mt-1">Monthly Expenditure Statement - MDM Scheme</h3>
            </div>
            <div class="w-16"></div>
        </div>

        <table>
            <thead class="bg-slate-50">
                <tr>
                    <th>Month</th>
                    <th>Scheme</th>
                    <th>Roll</th>
                    <th>Work Days</th>
                    <th>MDM Days</th>
                    <th>Stud. Cov.</th>
                    <th>Meals</th>
                    <th>Open Rice</th>
                    <th>Lifted</th>
                    <th>Utilized</th>
                    <th>Close Rice</th>
                    <th>Open Funds</th>
                    <th>Utilized Cost</th>
                    <th>Received</th>
                    <th>Close Funds</th>
                    <th>Cooks</th>
                </tr>
            </thead>
            <tbody id="statementBody">
                </tbody>
        </table>

        <div class="mt-8 flex justify-between items-end text-[10px]">
            <div class="space-y-1">
                <p><strong>MDM A/C:</strong> 0486040500000273</p>
                <p><strong>Cook:</strong> SHAHEENA BANO</p>
            </div>
            <div class="text-right w-48 pt-10 border-t border-black">
                <p class="font-black uppercase">Headmaster Signature</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from '../../assets/js/firebase.js';
        import { collection, query, where, getDocs, limit, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        window.fetchCurrentMonthData = async function() {
            const currentMonth = document.getElementById('reportMonth').value;
            if(!currentMonth) return;

            // 1. Calculate Previous Month String
            const date = new Date(currentMonth + "-01");
            date.setMonth(date.getMonth() - 1);
            const prevMonth = date.toISOString().substring(0, 7);

            try {
                // 2. Fetch Previous Month for Opening Balances
                const prevQuery = query(collection(db, "mdm_monthly_summaries"), where("monthYear", "==", prevMonth));
                const prevSnap = await getDocs(prevQuery);
                let openingRice = 0, openingFunds = 0;

                prevSnap.forEach(doc => {
                    openingRice = doc.data().closingRice || 0;
                    openingFunds = doc.data().closingFunds || 0;
                });

                // 3. Fetch All Daily Entries for Current Month
                const dailyQuery = query(collection(db, "mdm_entries"), where("monthYear", "==", currentMonth));
                const dailySnap = await getDocs(dailyQuery);
                
                let stats = {
                    ppRoll: 0, pRoll: 0, ppCov: 0, pCov: 0, 
                    riceLifted: 0, fundsRec: 0, 
                    riceUtil: 0, fundsUtil: 0,
                    daysServed: 0, ppRate: 5.45, pRate: 8.17 // Default Rates
                };

                dailySnap.forEach(doc => {
                    const d = doc.data();
                    stats.ppRoll = d.pp_enroll || stats.ppRoll;
                    stats.pRoll = d.p_enroll || stats.pRoll;
                    stats.ppCov += d.pp_present || 0;
                    stats.pCov += d.p_present || 0;
                    stats.riceLifted += d.rice_lifted || 0;
                    stats.fundsRec += d.funds_received || 0;
                    stats.riceUtil += (d.pp_present + d.p_present) * 0.1; // 100g each
                    stats.ppRate = d.pp_exp_rate || stats.ppRate;
                    stats.pRate = d.p_exp_rate || stats.pRate;
                    stats.daysServed++;
                });

                stats.fundsUtil = (stats.ppCov * stats.ppRate) + (stats.pCov * stats.pRate);
                
                renderTable(currentMonth, stats, openingRice, openingFunds);

            } catch (e) { console.error(e); }
        };

        function renderTable(month, s, opRice, opFunds) {
            const date = new Date(month + "-01");
            const label = date.toLocaleString('default', { month: 'short' }).toUpperCase() + " " + date.getFullYear();
            
            const closeRice = (opRice + s.riceLifted - s.riceUtil).toFixed(3);
            const closeFunds = (opFunds + s.fundsRec - s.fundsUtil).toFixed(2);

            document.getElementById('statementBody').innerHTML = `
                <tr>
                    <td rowspan="3" class="vertical-text font-bold">${label}</td>
                    <td class="font-bold">Pre-Pri</td>
                    <td>${s.ppRoll}</td><td>24</td><td>${s.daysServed}</td><td>${s.ppCov}</td><td>${s.ppCov}</td>
                    <td rowspan="3">${opRice.toFixed(3)}</td>
                    <td rowspan="3">${s.riceLifted.toFixed(3)}</td>
                    <td>${(s.ppCov * 0.1).toFixed(3)}</td>
                    <td rowspan="3">${closeRice}</td>
                    <td rowspan="3">${opFunds.toFixed(2)}</td>
                    <td>${(s.ppCov * s.ppRate).toFixed(2)}</td>
                    <td rowspan="3">${s.fundsRec.toFixed(2)}</td>
                    <td rowspan="3">${closeFunds}</td>
                    <td rowspan="3">1</td>
                </tr>
                <tr>
                    <td class="font-bold">Primary</td>
                    <td>${s.pRoll}</td><td>24</td><td>${s.daysServed}</td><td>${s.pCov}</td><td>${s.pCov}</td>
                    <td>${(s.pCov * 0.1).toFixed(3)}</td>
                    <td>${(s.pCov * s.pRate).toFixed(2)}</td>
                </tr>
                <tr class="bg-slate-100 font-black">
                    <td>TOTAL</td>
                    <td>${s.ppRoll + s.pRoll}</td><td>24</td><td>${s.daysServed}</td>
                    <td>${s.ppCov + s.pCov}</td><td>${s.ppCov + s.pCov}</td>
                    <td>${s.riceUtil.toFixed(3)}</td>
                    <td>${s.fundsUtil.toFixed(2)}</td>
                </tr>
            `;
        }
    </script>
</body>
</html>
                    
