<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Detailed Upload | GPS Pethgam Wagoora</title>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }
    .container { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .admin-nav { background: #1a5d1a; padding: 10px; display: flex; gap: 15px; justify-content: center; margin: -20px -20px 20px -20px; }
    .admin-nav a { color: white; text-decoration: none; font-weight: bold; font-size: 13px; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
    th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
    th { background: #e8f5e9; }
    input { width: 40px; padding: 3px; text-align: center; border: 1px solid #ddd; }
    .subject-label { text-align: left; font-weight: bold; width: 120px; }
    .btn-save { background: #1a5d1a; color: white; padding: 15px 30px; border: none; cursor: pointer; width: 100%; margin-top: 20px; font-weight: bold; }
  </style>
</head>
<body>

<div class="admin-nav">
    <a href="admission.html">üìù Admission</a>
    <a href="adm-register.html">üìã Register</a>
    <a href="upload-results.html">üì§ Upload Marks</a>
    <a href="results.html">üéì Online Result</a>
    <a href="master-profile.html">üë§ Master Profile</a>
</div>

<div class="container">
  <h2>Detailed Assessment Entry (Session 2024-25)</h2>
  
  <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
    <div><label>Adm No:</label> <input type="text" id="admNo" style="width: 100px;" oninput="lookupStudent()"></div>
    <div><label>Roll No:</label> <input type="text" id="rollNo" style="width: 100px;"></div>
    <div><label>Attendance %:</label> <input type="text" id="att" style="width: 60px;"></div>
  </div>
  <div id="studentName" style="color: darkgreen; font-weight: bold; margin-bottom: 15px;"></div>

  <table>
    <thead>
      <tr>
        <th>Subject</th>
        <th>FA1(5)</th><th>FA2(5)</th><th>FA3(5)</th><th>FA4(5)</th><th>FA5(5)</th><th>FA6(5)</th>
        <th>CCA(20)</th>
        <th>SA(50)</th>
      </tr>
    </thead>
    <tbody id="marksBody">
      </tbody>
  </table>
  <div style="margin-top:25px; border: 1px solid #1a5d1a; padding: 15px; border-radius: 4px; background: #f9fff9;">
  <h3 style="margin-top:0; color: #1a5d1a; font-size: 14px; border-bottom: 1px solid #1a5d1a;">Co-Scholastic Record</h3>
  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
    <div class="field-group">
      <label>Attendance %</label>
      <input type="text" id="att" style="width: 80%; text-align: center;">
    </div>
    <div class="field-group">
      <label>Discipline (Grade)</label>
      <select id="discipline" style="width: 100%; padding: 3px;">
        <option value="">Select</option>
        <option value="A">A</option>
        <option value="B">B</option>
        <option value="C">C</option>
      </select>
    </div>
    <div class="field-group">
      <label>Sports / Health</label>
      <select id="sports" style="width: 100%; padding: 3px;">
        <option value="">Select</option>
        <option value="A">A</option>
        <option value="B">B</option>
        <option value="C">C</option>
      </select>
    </div>
    <div class="field-group">
      <label>Art & Craft</label>
      <select id="artCraft" style="width: 100%; padding: 3px;">
        <option value="">Select</option>
        <option value="A">A</option>
        <option value="B">B</option>
        <option value="C">C</option>
      </select>
    </div>
  </div>
  </div>
  
  
  <div style="margin-top:20px;">
    <label>General Remarks:</label><br>
    <textarea id="remarks" style="width: 100%; height: 60px;"></textarea>
  </div>

  <button class="btn-save" onclick="saveData()">Save Assessment Record</button>
</div>

<script type="module">
// 1. Firebase Imports
import { db } from './init-firebase.js';
import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const subjects = ['English', 'Math', 'EVS', 'Urdu', 'Kashmiri'];
const tbody = document.getElementById('marksBody');

// Generate table rows
subjects.forEach(sub => {
    let row = `<tr>
        <td class="subject-label">${sub}</td>
        ${[1,2,3,4,5,6].map(i => `<td><input type="number" class="${sub}-fa" data-idx="${i}" max="5"></td>`).join('')}
        <td><input type="number" id="${sub}-cca" max="20"></td>
        <td><input type="number" id="${sub}-sa" max="50"></td>
    </tr>`;
    tbody.innerHTML += row;
});

// 2. Lookup Student from "admissions" collection
window.lookupStudent = async function() {
    const adm = document.getElementById('admNo').value.trim();
    if(!adm) return;

    try {
        const docRef = doc(db, "admissions", adm);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            const s = docSnap.data();
            document.getElementById('studentName').innerText = "Editing: " + s.studentName;
            
            // Optional: Try to auto-load existing marks if they exist
            loadExistingMarks(adm);
        } else {
            document.getElementById('studentName').innerText = "Student not found in admissions";
        }
    } catch (error) {
        console.error("Lookup error:", error);
    }
}

// 3. Save Data to "results" collection
window.saveData = async function() {
    const adm = document.getElementById('admNo').value.trim();
    if(!adm) return alert("Enter Adm No");

    const marks = {};
    subjects.forEach(sub => {
        const faInputs = document.querySelectorAll(`.${sub}-fa`);
        const faMarks = Array.from(faInputs).map(i => parseInt(i.value) || 0);
        marks[sub] = {
            fa: faMarks,
            cca: parseInt(document.getElementById(`${sub}-cca`).value) || 0,
            sa: parseInt(document.getElementById(`${sub}-sa`).value) || 0
        };
    });

    const data = {
        admNo: adm,
        rollNo: document.getElementById('rollNo').value,
        attendance: document.getElementById('att').value,
        remarks: document.getElementById('remarks').value,
        marks: marks,
        updatedAt: new Date().toISOString()
    };

    try {
        // Use adm as the document ID for easy lookup
        await setDoc(doc(db, "results", adm), data);
        alert("Record Saved to Cloud Successfully");
    } catch (error) {
        console.error("Save error:", error);
        alert("Error saving marks. Check console.");
    }
}

// Helper: Load marks if they already exist
async function loadExistingMarks(adm) {
    const docSnap = await getDoc(doc(db, "results", adm));
    if (docSnap.exists()) {
        const data = docSnap.data();
        document.getElementById('rollNo').value = data.rollNo || "";
        document.getElementById('att').value = data.attendance || "";
        document.getElementById('remarks').value = data.remarks || "";
        
        // Fill the marks inputs
        subjects.forEach(sub => {
            if(data.marks[sub]) {
                const faInputs = document.querySelectorAll(`.${sub}-fa`);
                faInputs.forEach((input, i) => {
                    input.value = data.marks[sub].fa[i] || 0;
                });
                document.getElementById(`${sub}-cca`).value = data.marks[sub].cca || 0;
                document.getElementById(`${sub}-sa`).value = data.marks[sub].sa || 0;
            }
        });
    }
}
</script>

</body>
</html>
    
